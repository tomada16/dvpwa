name: DevSecOps Pipeline Full Modular

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker Compose services
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose build

  sca_backend:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Run pip-audit
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose run --rm sqli sh -c "pip install pip-audit && pip-audit"

  sast:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Run Semgrep SAST
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose run --rm sqli sh -c "pip install semgrep && semgrep scan --config auto"

  secrets:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Run Gitleaks scan
        run: |
          docker run --rm zricethezav/gitleaks:latest detect --source . --no-git --report-format sarif --exit-code 0

  dast:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - uses: actions/checkout@v3

      - name: Start stack for DAST
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose up -d
          sleep 15

      - name: Prepare report directory
        run: mkdir -p zap-reports

      - name: Run OWASP ZAP DAST scan (without compose exec)
        continue-on-error: true
        run: |
          docker run --rm --network $(docker network ls --filter name=$(basename $PWD)_default --format "{{.Name}}") \
            -v ${{ github.workspace }}/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://sqli:8080 \
            -J report.json -w report.md -r report.html -I

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v3
        with:
          name: zap-reports
          path: zap-reports/

      - name: Stop Docker Compose stack
        run: docker-compose down

  release:
    runs-on: ubuntu-22.04
    needs: [build, test, sca_backend, sast, secrets, dast]
    steps:
      - uses: actions/checkout@v3
      - name: Docker Build & Push
        run: |
          docker build -t ${{ secrets.REGISTRY_URL }}/project:0.1 .
          echo "${{ secrets.REGISTRY_PASS }}" | docker login -u ${{ secrets.REGISTRY_USER }} --password-stdin ${{ secrets.REGISTRY_URL }}
          docker push ${{ secrets.REGISTRY_URL }}/project:0.1
